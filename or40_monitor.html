<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OR40 SOLOリロード 運営用モニター</title>
<style>
  :root {
    --bg:#0b0b0f;
    --gap:10px;
    --tileRadius:14px;
    --tileBorder:1px solid rgba(255,255,255,.12);
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Yu Gothic", sans-serif;

    --srcW:1920;
    --srcH:1080;

    /* Crop box from bottom-left (HP用) */
    --cropLeft: 0;
    --cropBottom: 0;
    --cropW: 560;
    --cropH: 320;

    --cols:8;
    --sideW: 420px;
  }

  html,body {
    height:100%;
    margin:0;
    background:var(--bg);
    color:#fff;
    font-family:var(--font);
    overflow:hidden;
  }

  .layout{
    height:100vh;
    display:grid;
    grid-template-rows: auto 1fr;
  }
  .main{
    height:100%;
    display:grid;
    grid-template-columns: 1fr var(--sideW);
    gap: var(--gap);
    padding: var(--gap);
    box-sizing:border-box;
    min-height:0;
  }

  /* ===== 上部バー（表示のみ） ===== */
  .top {
    position:sticky; top:0; z-index:20;
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    padding:10px 12px;
    background:linear-gradient(to bottom, rgba(11,11,15,.95), rgba(11,11,15,.65));
    backdrop-filter: blur(8px);
    border-bottom:1px solid rgba(255,255,255,.10);
  }
  .top b { font-size:14px; }

  .pill {
    padding:4px 10px;
    border:1px solid rgba(255,255,255,.14);
    border-radius:999px;
    background: rgba(255,255,255,.06);
    font-size:12px;
    opacity:.9;
    user-select:none;
  }

  .btn {
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    color:#fff;
    padding:6px 10px;
    border-radius:999px;
    cursor:pointer;
    font-weight:900;
    font-size:12px;
  }
  .btn.secondary { font-weight:800; opacity:.95; }

  /* ===== 左：グリッド ===== */
  .gridWrap{ min-height:0; }
  .grid {
    display:grid;
    grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
    gap: var(--gap);
    height: 100%;
    min-height:0;
  }

  .tile {
    position:relative;
    border-radius:var(--tileRadius);
    overflow:hidden;
    border:var(--tileBorder);
    background:#111;
    min-width:0;
    min-height:0;
  }
  .tile.hidden { display:none; }

  .badgeBtn {
    position:absolute;
    left:8px; top:8px;
    z-index:6;
    padding:3px 10px;
    border-radius:999px;
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.14);
    color:#fff;
    font-size:11px;
    font-weight:900;
    letter-spacing:.03em;
    user-select:none;
    pointer-events:none;
  }

  .crop { position:absolute; inset:0; overflow:hidden; background:#000; }
  iframe { border:0; background:#000; }

  #grid.mode-normal .inner { position:absolute; inset:0; transform:none !important; left:0 !important; top:0 !important; }
  #grid.mode-normal iframe { width:100%; height:100%; }

  #grid.mode-hp .inner {
    position:absolute;
    left: var(--innerLeft, 0px);
    top: var(--innerTop, 0px);
    transform: scale(var(--innerScale, 1));
    transform-origin: top left;
  }
  #grid.mode-hp iframe {
    width: calc(var(--srcW) * 1px);
    height: calc(var(--srcH) * 1px);
  }

  /* ===== 右：常時表示コントロール ===== */
  .side{
    min-height:0;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(15,16,22,.92);
    border-radius: 16px;
    box-shadow: 0 18px 55px rgba(0,0,0,.45);
    backdrop-filter: blur(10px);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  .sideHead{
    padding:12px 12px 10px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .sideHead b{ font-size:13px; }
  .sideHead .mini{ font-size:12px; opacity:.75; }

  .sideBody{
    padding:12px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
    min-height:0;
  }

  .rowBtns { display:flex; flex-wrap:wrap; gap:8px; }
  .rowBtns .btn { padding:6px 10px; }

  .box {
    padding: 10px;
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    background: rgba(255,255,255,.04);
    display:grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }
  .box label {
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-size:12px; opacity:.92;
  }
  .box input[type="range"] { width: 240px; }
  .note { font-size:12px; opacity:.7; line-height:1.25; }

  /* ★ボタンは 4×10（40個） */
  .numGrid {
    display:grid;
    grid-template-columns: repeat(4, 1fr); /* 4列 × 10行 */
    gap: 8px;
  }
  .num {
    user-select:none;
    cursor:pointer;
    border-radius: 12px;
    padding: 10px 0;
    text-align:center;
    font-weight:900;
    font-size:12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    opacity:.95;
  }
  .num:hover { background: rgba(255,255,255,.10); }
  .num.off { opacity:.35; background: rgba(255,255,255,.02); }

  /* ロック：表示はするが押せない */
  .num.locked{
    opacity:.35;
    background: rgba(255,255,255,.02);
    cursor:not-allowed;
    position:relative;
  }
  .num.locked:hover{ background: rgba(255,255,255,.02); }
  .num.locked::after{
    content:"LOCK";
    position:absolute;
    inset:auto 8px 8px auto;
    font-size:10px;
    opacity:.75;
    letter-spacing:.06em;
  }

  @media (max-width: 1180px){
    :root{ --sideW: 360px; }
    .box input[type="range"]{ width: 200px; }
  }
  @media (max-width: 980px){
    .main{
      grid-template-columns: 1fr;
      grid-template-rows: 1fr auto;
    }
    .side{ max-height: 48vh; }
  }
</style>
</head>

<body>
<div class="layout">
  <!-- ★上部：現在モードは表示のみ（切替不可） -->
  <div class="top">
    <b>OR40 SOLOリロード 運営用モニター</b>
    <span class="pill">表示中：<span id="remain">0</span></span>
    <span class="pill" id="modeLabel">表示：HP</span>
  </div>

  <div class="main">
    <div class="gridWrap">
      <div class="grid mode-hp" id="grid"></div>
    </div>

    <aside class="side">
      <div class="sideHead">
        <div>
          <b>表示ON/OFF（クリックで切替）</b>
          <div class="mini">ボタン40個（4×10） / ロック番号は切替不可</div>
        </div>
      </div>

      <div class="sideBody">
        <div class="rowBtns">
          <button class="btn secondary" onclick="showAll()">全表示</button>
          <button class="btn secondary" onclick="hideAll()">全非表示</button>
          <!-- ★操作パネル側の通常⇔HPは有効 -->
          <button class="btn" id="btnModeSide" onclick="toggleMode()">通常⇔HP</button>
        </div>

        <div class="box">
          <div class="note">HPは左下から範囲指定。分割が変わってもズレない。</div>
          <label>範囲幅 cropW <span><input type="range" min="300" max="900" step="10" value="560" oninput="setCropW(this.value)"></span></label>
          <label>範囲高 cropH <span><input type="range" min="200" max="700" step="10" value="320" oninput="setCropH(this.value)"></span></label>
          <label>下から cropBottom <span><input type="range" min="0" max="400" step="10" value="0" oninput="setCropBottom(this.value)"></span></label>
          <label>左から cropLeft <span><input type="range" min="0" max="600" step="10" value="0" oninput="setCropLeft(this.value)"></span></label>
        </div>

        <div class="numGrid" id="numGrid"></div>

        <div class="note">音声：全iframeが <b>mute</b>（0）</div>
      </div>
    </aside>
  </div>
</div>

<script>
  /* =========================
     設定
     - 初期表示：1～25 と 40
     - ロック：26～39（ボタンは出るが押せない＝表示切替不可）
  ========================= */
  const INITIAL_VISIBLE = new Set([
    ...Array.from({length:25}, (_,i)=>i+1),
    40
  ]);
  const LOCKED = new Set(Array.from({length:14}, (_,i)=>i+26)); // 26..39
  const FORCE_HIDE_LOCKED_ON_BOOT = true;

  const total = 40;
  let mode = 'normal'; // 'hp' or 'normal'

  function pad3(n){ return String(n).padStart(3,'0'); }

  function computeCols(n){
    if(n <= 2) return 2;
    if(n <= 4) return 2;
    if(n <= 6) return 3;
    if(n <= 9) return 3;
    if(n <= 12) return 4;
    if(n <= 16) return 4;
    if(n <= 20) return 5;
    if(n <= 24) return 6;
    if(n <= 30) return 6;
    if(n <= 36) return 7;
    return 8;
  }

  function getNumVar(name) {
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return Number(v);
  }

  function computeCropTransform(containerW, containerH){
    const cropW = getNumVar('--cropW');
    const cropH = getNumVar('--cropH');
    const cropLeft = getNumVar('--cropLeft');
    const cropBottom = getNumVar('--cropBottom');
    const srcH = getNumVar('--srcH');

    const s = Math.min(containerW / cropW, containerH / cropH);
    const cropTop = srcH - cropBottom - cropH;
    const left = (-cropLeft * s);
    const top = (-cropTop * s);
    return {s, left, top};
  }

  function refreshModeLabels(){
    const text = (mode === 'hp') ? '表示：HP' : '表示：通常';
    document.getElementById('modeLabel').textContent = text;          // 上部は表示のみ
    document.getElementById('btnModeSide').textContent = '通常⇔HP：' + ((mode === 'hp') ? 'HP' : '通常');
  }

  function applyMode(){
    const grid = document.getElementById('grid');
    grid.classList.toggle('mode-hp', mode === 'hp');
    grid.classList.toggle('mode-normal', mode === 'normal');
    refreshModeLabels();
    requestAnimationFrame(updateAllTransforms);
  }

  function toggleMode(){
    mode = (mode === 'hp') ? 'normal' : 'hp';
    applyMode();
  }

  function setVar(name, v){
    document.documentElement.style.setProperty(name, Number(v));
    requestAnimationFrame(updateAllTransforms);
  }
  function setCropW(v){ setVar('--cropW', v); }
  function setCropH(v){ setVar('--cropH', v); }
  function setCropBottom(v){ setVar('--cropBottom', v); }
  function setCropLeft(v){ setVar('--cropLeft', v); }

  function updateOneTransform(tileEl){
    if(mode !== 'hp') return;
    if(tileEl.classList.contains('hidden')) return;
    const inner = tileEl.querySelector('.inner');
    if(!inner) return;
    const rect = tileEl.getBoundingClientRect();
    const t = computeCropTransform(rect.width, rect.height);
    inner.style.setProperty('--innerScale', t.s);
    inner.style.setProperty('--innerLeft', t.left + 'px');
    inner.style.setProperty('--innerTop', t.top + 'px');
  }
  function updateAllTransforms(){
    document.querySelectorAll('.tile').forEach(updateOneTransform);
  }

  function updateLayout(){
    const tiles = Array.from(document.querySelectorAll('.tile'));
    const visible = tiles.filter(t => !t.classList.contains('hidden'));
    document.getElementById('remain').textContent = visible.length;
    document.documentElement.style.setProperty('--cols', computeCols(visible.length));
    requestAnimationFrame(updateAllTransforms);
  }

  function setVisible(idx, on){
    if(LOCKED.has(idx)) return; // ロック番号は変更不可
    const tile = document.getElementById('tile'+idx);
    const num = document.getElementById('num'+idx);
    if(!tile || !num) return;

    tile.classList.toggle('hidden', !on);
    num.classList.toggle('off', !on);

    updateLayout();
    updateIframeResolution();
  }

  function toggleOne(idx){
    if(LOCKED.has(idx)) return;
    const tile = document.getElementById('tile'+idx);
    const turningOn = tile.classList.contains('hidden');
    setVisible(idx, turningOn);
  }

  function showAll(){
    for(let i=1;i<=total;i++){
      if(LOCKED.has(i)) continue;
      setVisible(i, true);
    }
  }
  function hideAll(){
    for(let i=1;i<=total;i++){
      if(LOCKED.has(i)) continue;
      setVisible(i, false);
    }
  }

  function calcViewSize(){
    const tiles = Array.from(document.querySelectorAll('.tile')).filter(t=>!t.classList.contains('hidden'));
    if(tiles.length === 0) return {w:256,h:144};
    const r = tiles[0].getBoundingClientRect();
    const w = Math.max(120, Math.floor(r.width));
    const h = Math.max(68, Math.floor(r.height));
    return {w,h};
  }

  function updateIframeResolution(){
    const {w,h} = calcViewSize();
    document.querySelectorAll('#grid iframe').forEach(f=>{
      if(!f.src.includes('vdo.ninja')) return;
      const u = new URL(f.src);
      u.searchParams.set('viewwidth', w);
      u.searchParams.set('viewheight', h);
      f.src = u.toString();
    });
  }

  function buildTiles(){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';

    for(let i=1;i<=total;i++){
      const cid = 'C' + pad3(i);

      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.id = 'tile' + i;
      tile.dataset.idx = String(i);

      const shouldShow = INITIAL_VISIBLE.has(i);
      const forceHide = FORCE_HIDE_LOCKED_ON_BOOT && LOCKED.has(i);
      if(!shouldShow || forceHide) tile.classList.add('hidden');

      const badge = document.createElement('div');
      badge.className = 'badgeBtn';
      badge.textContent = cid;

      const crop = document.createElement('div');
      crop.className = 'crop';

      const inner = document.createElement('div');
      inner.className = 'inner';
      inner.id = 'inner' + i;

      const iframe = document.createElement('iframe');
      iframe.id = 'frame' + i;
      iframe.allow = 'autoplay; display-capture';

      // 音声は全部0（mute）
      iframe.src =
        `https://vdo.ninja/?view=OR40_${cid}` +
        `&cleanoutput&viewwidth=256&viewheight=144&mute`;

      inner.appendChild(iframe);
      crop.appendChild(inner);
      tile.appendChild(badge);
      tile.appendChild(crop);
      grid.appendChild(tile);
    }
  }

  function buildNumGrid(){
    const wrap = document.getElementById('numGrid');
    wrap.innerHTML = '';

    for(let i=1;i<=total;i++){
      const d = document.createElement('div');
      d.className = 'num';
      d.id = 'num' + i;
      d.textContent = String(i).padStart(2,'0');

      const initOn = INITIAL_VISIBLE.has(i) && !(FORCE_HIDE_LOCKED_ON_BOOT && LOCKED.has(i));
      d.classList.toggle('off', !initOn);

      if(LOCKED.has(i)){
        d.classList.add('locked');
        d.onclick = (e)=>{ e.stopPropagation(); };
      }else{
        d.onclick = (e)=>{ toggleOne(i); e.stopPropagation(); };
      }
      wrap.appendChild(d);
    }
  }

  const ro = new ResizeObserver(() => {
    requestAnimationFrame(updateAllTransforms);
    requestAnimationFrame(updateIframeResolution);
  });
  ro.observe(document.body);

  // init
  buildTiles();
  buildNumGrid();
  applyMode();
  updateLayout();
  updateIframeResolution();
</script>
</body>
</html>
