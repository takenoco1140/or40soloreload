<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Final Results Overlay</title>
<style>
html,body{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden}
body{display:flex;justify-content:center;align-items:center;font-family:"Segoe UI","Noto Sans JP",system-ui,sans-serif}
.board{position:relative;width:1920px;height:1080px;background:url("./result/総合結果台紙.jpg") center/contain no-repeat;background-color:#000;color:#fff}
.text{position:absolute;text-align:center;text-shadow:0 2px 6px rgba(0,0,0,.8)}

/* ★ズレ防止：displayではなく visibility を使う */
.vhidden{visibility:hidden !important;}
.ohidden{opacity:0 !important;}

.rank{width:520px}
.rank .place{font-size:40px;font-weight:800;margin-bottom:6px}
.rank .nameimg{
  display:block;margin:0 auto;
  height:96px;                /* 高さ固定 */
  width:auto;max-width:520px;
  object-fit:contain;
  filter:drop-shadow(0 3px 10px rgba(0,0,0,.75));
}
.rank .scoreline{margin-top:10px;font-size:30px;font-weight:700;white-space:nowrap}

.first{top:580px;left:50%;transform:translateX(-50%)}
.second{top:650px;left:320px}
.third{top:650px;right:320px}
.first .place{color:#ffd966}.second .place{color:#9fe8d5}.third .place{color:#ffb07c}

/* MVP */
.mvp{position:absolute;top:380px;left:50%;transform:translateX(-50%);text-align:center}
.mvp .row{display:flex;align-items:center;justify-content:center;gap:14px}
.mvp img{height:90px;object-fit:contain;filter:drop-shadow(0 3px 10px rgba(0,0,0,.75))}
.mvp .kills{margin-top:6px;font-size:28px;font-weight:800}
</style>
</head>
<body>
<div class="board">
  <button id="openPanel" style="position:absolute;top:16px;right:16px;z-index:5">操作</button>

  <div id="rank1" class="text rank first">
    <div class="place">1st</div>
    <img id="img1" class="nameimg ohidden">
    <div id="score1" class="scoreline vhidden">総合 0pt（順位 0pt、撃破 0pt）</div>
  </div>
  <div id="rank2" class="text rank second">
    <div class="place">2nd</div>
    <img id="img2" class="nameimg ohidden">
    <div id="score2" class="scoreline vhidden">総合 0pt（順位 0pt、撃破 0pt）</div>
  </div>
  <div id="rank3" class="text rank third">
    <div class="place">3rd</div>
    <img id="img3" class="nameimg ohidden">
    <div id="score3" class="scoreline vhidden">総合 0pt（順位 0pt、撃破 0pt）</div>
  </div>

  <div id="mvp" class="mvp vhidden">
    <div class="row">
      <img src="./result/mostelim.png">
      <img id="mvpImg" class="nameimg ohidden">
    </div>
    <div id="mvpKills" class="kills">最多撃破 0</div>
  </div>
</div>

<script>
const BASE='./name';
const imgEls={1:img1,2:img2,3:img3};
const scoreEls={1:score1,2:score2,3:score3};
let assignIndex=0;
function pad(n){return String(n).padStart(3,'0')}
function nameSrc(n){return `${BASE}/N${pad(n)}.png`}

function setName(rank,n){
  const el=imgEls[rank];
  el.onload=()=>el.classList.remove('ohidden');
  el.src=nameSrc(n);
  el.classList.remove('vhidden');
}
function setPoints(rank,rankPt,killPt){
  rankPt=Number(rankPt)||0;killPt=Number(killPt)||0;
  scoreEls[rank].innerHTML=`総合 ${rankPt+killPt}pt（順位 ${rankPt}pt、撃破 ${killPt}pt）`;
  scoreEls[rank].classList.remove('vhidden');
}

function allOff(){[1,2,3].forEach(r=>{imgEls[r].classList.add('vhidden');scoreEls[r].classList.add('vhidden')})}
function ptOn(){[1,2,3].forEach(r=>scoreEls[r].classList.remove('vhidden'))}
function nameOn(){[1,2,3].forEach(r=>imgEls[r].classList.remove('vhidden'))}
function bothOn(){ptOn();nameOn()}

function mvpOn(){mvp.classList.remove('vhidden')}
function mvpOff(){mvp.classList.add('vhidden')}
function setMvp(n,k){mvpOn();mvpImg.onload=()=>mvpImg.classList.remove('ohidden');mvpImg.src=nameSrc(n);mvpKills.textContent=`最多撃破 ${Number(k)||0}`}

/* ===== 別窓ポップアップ（デザインは旧controls踏襲） ===== */
let win;
document.getElementById('openPanel').onclick=()=>{
  if(win&&!win.closed){win.focus();return}
  win=window.open('','panel','width=420,height=900');
  win.document.write(`<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>操作パネル</title>
  <style>body{margin:0;padding:12px;background:#111;color:#fff;font-family:system-ui}
  .panel{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;margin-bottom:12px}
  h3{margin:0 0 8px;font-size:13px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:8px 10px;font-weight:900;background:rgba(255,255,255,.12);color:#fff}
  .btn.primary{background:rgba(255,255,255,.22)}
  .btn.danger{background:rgba(255,90,90,.3)}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
  input{width:100%;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#000;color:#fff;font-weight:800}
  </style></head><body>

  <div class=panel><h3>表示</h3>
    <div class=row>
      <button class='btn danger' onclick='opener.allOff()'>全OFF</button>
      <button class='btn' onclick='opener.ptOn()'>pt</button>
      <button class='btn' onclick='opener.nameOn()'>名前</button>
      <button class='btn primary' onclick='opener.bothOn()'>同時</button>
    </div>
  </div>

  <div class=panel><h3>名前画像</h3><div class=grid id=g></div></div>

  <div class=panel><h3>ポイント</h3>
    1位<input id=r1 value=0><input id=k1 value=0><button class='btn primary' onclick='opener.setPoints(1,r1.value,k1.value)'>反映</button><br><br>
    2位<input id=r2 value=0><input id=k2 value=0><button class='btn primary' onclick='opener.setPoints(2,r2.value,k2.value)'>反映</button><br><br>
    3位<input id=r3 value=0><input id=k3 value=0><button class='btn primary' onclick='opener.setPoints(3,r3.value,k3.value)'>反映</button>
  </div>

  <div class=panel><h3>MVP</h3>
    <button class='btn primary' onclick='opener.mvpOn()'>ON</button>
    <button class='btn danger' onclick='opener.mvpOff()'>OFF</button><br><br>
    番号<input id=mn value=1> 撃破<input id=mk value=0>
    <button class='btn primary' onclick='opener.setMvp(mn.value,mk.value)'>反映</button>
  </div>

  <script>
    const g=document.getElementById('g');
    for(let i=1;i<=40;i++){
      const b=document.createElement('button');b.className='btn';b.textContent='N'+String(i).padStart(3,'0');
      b.onclick=()=>{opener.setName([1,2,3][Math.min(opener.assignIndex||0,2)],i);opener.assignIndex=Math.min((opener.assignIndex||0)+1,2)};
      g.appendChild(b);
    }
  <\/script>
</body></html>`);
};

/* 初期 */
allOff();
</script>
</body>
</html>
