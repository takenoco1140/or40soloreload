<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>OR40 Single View</title>

<style>
  :root{
    /* === ネームプレート（16:9基準） === */
    --plateTop: 2%;
    --plateLeft: 1%;
    --plateWidth: 40%;
  }

  html, body{
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    background:#000;
    overflow:hidden;
    font-family:sans-serif;
  }

  #frame{
    position:relative;
    width:100%;
    height:100%;
    background:#000;
  }

  #gameArea{
    position:absolute;
    inset:0;
    overflow:hidden;
  }

  #game16x9{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:#000;
    overflow:hidden;
  }

  #game{
    width:100%;
    height:100%;
    border:none;
    display:block;
  }

  /* ネームプレート（ゲーム画面基準） */
  #nameplate{
    position:absolute;
    top:var(--plateTop);
    left:var(--plateLeft);
    z-index:10;
    pointer-events:none;
  }

  #nameplate img{
    width:var(--plateWidth);
    height:auto;
    display:block;
  }
</style>
</head>

<body>
<div id="frame">
  <div id="gameArea">
    <div id="game16x9">

      <iframe
        id="game"
        allow="autoplay; fullscreen; camera; microphone"
        allowfullscreen
        scrolling="no"></iframe>

      <div id="nameplate">
        <img id="nameImg" src="" alt="">
      </div>

    </div>
  </div>
</div>

<script>
  const MAX_PLAYERS = 40;

  // ★ localStorage key（controllerと一致させる）
  const LS_KEY_PLAYER = "or40_player";
  const LS_KEY_NP     = "or40_np"; // 1=表示 / 0=非表示（任意）

  function pad(n){ return String(n).padStart(3,"0"); }

  function viewUrl(n){
    return `https://vdo.ninja/?view=OR40_C${pad(n)}&cleanoutput`;
  }

  function plateUrl(n){
    return `overlays/P${pad(n)}.png`;
  }

  function fitGame16x9Cover(){
    const area = document.getElementById("gameArea");
    const box  = document.getElementById("game16x9");

    const W = area.clientWidth;
    const H = area.clientHeight;

    const target = 16/9;
    const ar = W / H;

    let bw, bh;
    if(ar >= target){
      bh = H;
      bw = Math.ceil(H * target);
    }else{
      bw = W;
      bh = Math.ceil(W / target);
    }

    box.style.width  = bw + "px";
    box.style.height = bh + "px";
  }
  window.addEventListener("resize", fitGame16x9Cover);

  function setPlayer(n){
    n = Number(n);
    if(!Number.isFinite(n) || n < 1 || n > MAX_PLAYERS) return;

    const t = Date.now();

    const iframe = document.getElementById("game");
    iframe.src = "about:blank"; // OBS/CEF対策
    setTimeout(() => {
      iframe.src = viewUrl(n) + `&t=${t}`;
    }, 30);

    const img = document.getElementById("nameImg");
    img.src = plateUrl(n) + `?t=${t}`;
    img.alt = `P${pad(n)}`;
  }

  function setNameplateVisible(isVisible){
    document.getElementById("nameplate").style.display = isVisible ? "block" : "none";
  }

  function readPlayerFromLocalStorage(){
    const raw = localStorage.getItem(LS_KEY_PLAYER);
    const n = Number(raw);
    if(Number.isFinite(n) && n >= 1 && n <= MAX_PLAYERS) return n;
    return 1;
  }

  function readNpFromLocalStorage(){
    const raw = localStorage.getItem(LS_KEY_NP);
    // 未設定なら表示
    if(raw === null) return true;
    return raw !== "0";
  }

  /* 初期化 */
  fitGame16x9Cover();
  setNameplateVisible(readNpFromLocalStorage());
  setPlayer(readPlayerFromLocalStorage());
</script>
</body>
</html>
